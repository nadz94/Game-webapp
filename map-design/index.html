<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Hajj Map Cutscene Demo</title>
    <style>
        :root {
            --sand-color: #e8c47a;
            --grid-line-color: #d9b36c;
            --label-bg: #111;
            --label-text: #eee;
            --bg-color: #222;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            flex-direction: column;
        }

        #canvas-container {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            border: 4px solid #444;
        }

        canvas {
            /* CRITICAL property for pixel art aesthetic */
            image-rendering: pixelated;
            image-rendering: crisp-edges;

            /* Ensure canvas fills container while maintaining aspect ratio */
            display: block;
            max-width: 100%;
            height: auto;
            /* Fallback background before JS loads */
            background-color: var(--sand-color);
        }

        .controls {
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="canvas-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>
    <div class="controls">
        <p>Cutscene Demo: Character moving through Hajj sequence.</p>
    </div>

    <script>
        /**
         * HajjGameMap Module
         * Handles rendering the pixel map and managing character movement for cutscenes.
         */
        const HajjGameMap = (function () {
            let canvas, ctx;
            let lastTime = 0;
            let bgImage = new Image();
            let bgLoaded = false;

            // --- Configuration & Data ---

            // The internal resolution of the game map.
            const GAME_WIDTH = 800;
            const GAME_HEIGHT = 600;

            // Visual coordinates mapped from the pixel art map (map_bg.jpg)
            const locations = {
                kabah: { x: 45, y: 245 },
                jamrat: { x: 187, y: 217 },
                mina: { x: 293, y: 265 },
                muzdalifah: { x: 412, y: 235 },
                arafat: { x: 600, y: 420 }
            };

            // Character State
            let character = {
                x: locations.kabah.x, // Start position
                y: locations.kabah.y,
                color: '#ff3300', // Placeholder red pixel character
                size: 32 // Size in pixels
            };

            // Movement State for cutscenes
            let movement = {
                isMoving: false,
                startX: 0,
                startY: 0,
                targetX: 0,
                targetY: 0,
                startTime: 0,
                duration: 0
            };

            // -----------------------------------
            // Initialization
            // -----------------------------------
            function init(canvasId) {
                canvas = document.getElementById(canvasId);
                if (!canvas) return;
                ctx = canvas.getContext('2d');

                // Enforce internal resolution
                canvas.width = GAME_WIDTH;
                canvas.height = GAME_HEIGHT;

                // Load Background Image
                bgImage.src = 'map_bg.jpg';
                bgImage.onload = () => {
                    bgLoaded = true;
                    console.log("Map background loaded.");
                };

                // Add helper listener to log coordinates on click
                canvas.addEventListener('mousedown', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const x = Math.round((e.clientX - rect.left) * scaleX);
                    const y = Math.round((e.clientY - rect.top) * scaleY);
                    console.log(`Clicked Coordinates: { x: ${x}, y: ${y} }`);
                });

                // Start the game loop
                requestAnimationFrame(gameLoop);
                console.log("Hajj Map initialized. Click anywhere on the map to find coordinates.");
            }

            // -----------------------------------
            // Game Loop & Logic
            // -----------------------------------
            function gameLoop(timestamp) {
                let dt = timestamp - lastTime;
                lastTime = timestamp;

                update(dt);
                draw();

                requestAnimationFrame(gameLoop);
            }

            function update(dt) {
                if (!movement.isMoving) return;

                const now = performance.now();
                const elapsed = now - movement.startTime;
                let progress = Math.min(elapsed / movement.duration, 1.0);

                // EaseInOutQuad
                const easedProgress = progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 2) / 2;

                // Linear Interpolation (LERP)
                character.x = movement.startX + (movement.targetX - movement.startX) * easedProgress;
                character.y = movement.startY + (movement.targetY - movement.startY) * easedProgress;

                if (progress >= 1.0) {
                    movement.isMoving = false;
                    character.x = movement.targetX;
                    character.y = movement.targetY;
                }
            }

            // -----------------------------------
            // Rendering
            // -----------------------------------
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 1. Draw Background
                if (bgLoaded) {
                    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
                } else {
                    // Fallback while loading
                    ctx.fillStyle = '#e8c47a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000';
                    ctx.fillText("Loading Map...", 20, 30);
                }

                // 2. Draw Character
                drawCharacter();
            }

            // --- ASSETS & CONSTANTS ---
            const COLORS = {
                WHITE: '#ffffff',
                BLACK: '#000000',
                SKIN: '#ffccaa',
                SKIN_DARK: '#8b4513',
                SHIRT: '#4488cc',
                PANTS: '#333333',
                SANDAL: '#5d4037',
                IHRAM_SHADOW: '#dddddd',
                HAIR: '#3e2723'
            };

            function drawCharacter() {
                const x = Math.round(character.x - (character.size / 2));
                const y = Math.round(character.y - (character.size / 2));
                drawMiniPlayer(ctx, x, y, true); // true for isIhram
            }

            // Adapted from Renderer.drawPlayer
            function drawMiniPlayer(ctx, dx, dy, isIhram) {
                // Helper for small rects - scaled by 2 to double the character size
                const s = 2;
                const r = (rx, ry, w, h, col) => {
                    ctx.fillStyle = col;
                    ctx.fillRect(dx + rx * s, dy + ry * s, w * s, h * s);
                };

                // --- FEET & SANDALS ---
                // Left foot
                r(4, 14, 3, 2, COLORS.SKIN);
                r(4, 15, 3, 1, COLORS.SANDAL);
                // Right foot
                r(9, 14, 3, 2, COLORS.SKIN);
                r(9, 15, 3, 1, COLORS.SANDAL);

                // --- BODY ---
                if (isIhram) {
                    // Main white garment
                    r(3, 6, 10, 9, COLORS.WHITE);
                    // Idtiba (Right shoulder bare, Left covered)
                    // Expose top-right of body block to skin
                    r(10, 6, 3, 3, COLORS.SKIN);

                    // Draping/Shadow details
                    r(3, 8, 2, 1, COLORS.IHRAM_SHADOW);
                    r(11, 10, 2, 1, COLORS.IHRAM_SHADOW);
                    r(4, 12, 8, 1, COLORS.IHRAM_SHADOW);
                } else {
                    // Normal clothes
                    r(3, 6, 10, 6, COLORS.SHIRT);
                    r(4, 12, 8, 3, COLORS.PANTS);
                }

                // --- ARMS ---
                // Arms down
                r(1, 6, 3, 6, COLORS.SKIN); // Left arm
                r(12, 6, 3, 6, COLORS.SKIN); // Right arm

                // --- HEAD ---
                // Face base
                r(4, 0, 8, 7, COLORS.SKIN);

                // Hair (or lack thereof if Ihram/Bald)
                if (!isIhram) {
                    r(4, 0, 8, 2, COLORS.HAIR); // Top hair
                    r(3, 1, 1, 3, COLORS.HAIR); // Sideburn L
                    r(12, 1, 1, 3, COLORS.HAIR); // Sideburn R
                }

                // Eyes
                r(5, 3, 2, 2, COLORS.BLACK);
                r(9, 3, 2, 2, COLORS.BLACK);

                // Beard
                r(4, 5, 8, 2, COLORS.HAIR);
                r(5, 7, 6, 1, COLORS.HAIR);
            }

            // -----------------------------------
            // Public API
            // -----------------------------------

            function moveToLocation(locationKey, durationSeconds = 2.0) {
                const target = locations[locationKey];
                if (!target) {
                    console.error(`Location '${locationKey}' not found.`);
                    return;
                }

                movement.startX = character.x;
                movement.startY = character.y;
                movement.targetX = target.x;
                movement.targetY = target.y;
                movement.startTime = performance.now();
                movement.duration = durationSeconds * 1000;
                movement.isMoving = true;
            }

            function setCharacterPosition(locationKey) {
                const target = locations[locationKey];
                if (target) {
                    character.x = target.x;
                    character.y = target.y;
                }
            }

            return {
                init: init,
                moveToLocation: moveToLocation,
                setCharacterPosition: setCharacterPosition
            };

        })();


        // =========================================
        // Integration & Demo Code
        // =========================================

        // 1. Initialize the map engine
        HajjGameMap.init('gameCanvas');

        // 2. Run a demo sequence to show cutscene functionality
        // This simulates the progression of Hajj based on the map flow.
        setTimeout(() => {
            runDemoSequence();
        }, 1000);

        async function runDemoSequence() {
            const pause = ms => new Promise(res => setTimeout(res, ms));

            // Reset to start
            HajjGameMap.setCharacterPosition('kabah');
            await pause(1000);

            // Sequence: Kabah -> Jamrat -> Mina -> Muzdalifah -> Arafat

            // Move to Jamrat (takes 3 seconds)
            HajjGameMap.moveToLocation('jamrat', 3.0);
            await pause(4000); // wait for movement + pause

            // Move to Mina (takes 2 seconds)
            HajjGameMap.moveToLocation('mina', 2.0);
            await pause(3000);

            // Move to Muzdalifah (takes 3 seconds)
            HajjGameMap.moveToLocation('muzdalifah', 3.0);
            await pause(4000);

            // Move to Arafat (takes 4 seconds long trek)
            HajjGameMap.moveToLocation('arafat', 4.0);
            await pause(5000);

            console.log("Demo sequence complete.");
        }

    </script>
</body>

</html>